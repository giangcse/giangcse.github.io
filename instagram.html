<!DOCTYPE html>
<!-- Thêm class="dark" ở đây để bật dark mode mặc định nếu muốn -->
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài liệu nghiên cứu khoa học</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for star icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    <script>
        // CẤU HÌNH DARK MODE CHO TAILWIND
        tailwind.config = {
          darkMode: 'class', // Bật chế độ dark mode dựa trên class
          theme: {
            extend: {
              // Bạn có thể thêm các màu sắc tùy chỉnh ở đây nếu cần
            }
          }
        }
    </script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* FIX: Xóa @apply khỏi CSS, di chuyển class vào HTML/JS */
        .profile-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        #scrollToTopBtn {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<!-- FIX: Thêm các class cho body trực tiếp vào đây -->
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-10 transition-colors duration-300">
        <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100 flex items-center">
                <i class="fab fa-instagram text-pink-500 mr-3"></i>
                Tài liệu nghiên cứu khoa học
            </h1>
            <!-- NÚT CHUYỂN DARK/LIGHT MODE -->
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                <i id="theme-toggle-dark-icon" class="hidden fas fa-moon"></i>
                <i id="theme-toggle-light-icon" class="hidden fas fa-sun"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-8">
        <!-- Loading Spinner -->
        <div id="loading" class="flex justify-center items-center py-16">
            <div class="w-16 h-16 border-4 border-dashed border-gray-400 dark:border-gray-600 rounded-full animate-spin"></div>
        </div>

        <!-- Profiles Grid -->
        <div id="profiles-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6">
            <!-- Dữ liệu profile sẽ được chèn vào đây bằng JavaScript -->
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden text-center mt-8 bg-red-100 text-red-700 p-4 rounded-lg">
            <p class="font-bold">Đã xảy ra lỗi!</p>
            <p>Không thể tải dữ liệu từ Airtable. Vui lòng kiểm tra lại cấu hình và API key.</p>
        </div>
    </main>

    <!-- NÚT SCROLL TO TOP -->
    <button id="scrollToTopBtn" class="hidden fixed bottom-5 right-5 bg-pink-500 text-white w-12 h-12 rounded-full shadow-lg hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-pink-400">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // --- CẤU HÌNH AIRTABLE ---
        const AIRTABLE_API_KEY = "patNTQ16tN1lO8XPS.875e8fa46f7d36ca5963ee069e77c7ed341abd1bbbe4da4e60528a20ec6c3491";
        const BASE_ID = "app6Th0E9WNStZhGl";
        const TABLE_NAME = "INSTAGRAM PROFILES";

        // --- LOGIC GIAO DIỆN ---
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');

        // Hàm hiển thị sao
        function renderStars(rating) {
            if (typeof rating !== 'number' || rating < 0) {
                return '<span class="text-gray-400 dark:text-gray-500">Chưa có xếp hạng</span>';
            }
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += i <= rating ? '<i class="fas fa-star text-yellow-400"></i>' : '<i class="far fa-star text-gray-300 dark:text-gray-600"></i>';
            }
            return starsHtml;
        }

        // 1. LOGIC DARK/LIGHT MODE
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            darkIcon.classList.remove('hidden');
        }

        themeToggleBtn.addEventListener('click', function() {
            darkIcon.classList.toggle('hidden');
            lightIcon.classList.toggle('hidden');
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });

        // 2. LOGIC SCROLL TO TOP
        window.onscroll = function() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollToTopBtn.classList.remove('hidden');
            } else {
                scrollToTopBtn.classList.add('hidden');
            }
        };
        scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        // 3. LOGIC LẤY DỮ LIỆU TỪ AIRTABLE
        async function fetchAndRenderProfiles() {
            const profilesGrid = document.getElementById('profiles-grid');
            const loadingSpinner = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');

            const encodedTableName = encodeURIComponent(TABLE_NAME);
            let allRecords = [];
            let offset = null;

            try {
                do {
                    const urlWithOffset = `https://api.airtable.com/v0/${BASE_ID}/${encodedTableName}?pageSize=100${offset ? `&offset=${offset}` : ''}`;
                    const response = await fetch(urlWithOffset, {
                        headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }
                    });

                    if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);

                    const data = await response.json();
                    allRecords = [...allRecords, ...data.records];
                    offset = data.offset; // Nếu còn data, Airtable sẽ trả về offset

                } while (offset); // Tiếp tục loop nếu còn offset

                loadingSpinner.style.display = 'none';

                if (!allRecords || allRecords.length === 0) {
                    profilesGrid.innerHTML = '<p class="text-center col-span-full text-gray-500 dark:text-gray-400">Không tìm thấy hồ sơ nào.</p>';
                    return;
                }

                // Render từng record
                allRecords.forEach(record => {
                    const fields = record.fields;
                    if (!fields.full_name || !fields.URL) return;

                    const profileCard = document.createElement('a');
                    profileCard.href = fields.URL;
                    profileCard.target = '_blank';
                    // FIX: Thêm class cho profile card trực tiếp vào đây
                    profileCard.className = 'profile-card bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden block';

                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'h-40 sm:h-48 bg-gray-200 dark:bg-gray-700';

                    const img = document.createElement('img');
                    img.src = fields.profile_pic_url || '';
                    img.alt = `Ảnh đại diện của ${fields.full_name}`;
                    img.className = 'w-full h-full object-cover';
                    img.onerror = function() {
                        const fallbackInitial = fields.full_name.charAt(0).toUpperCase();
                        const fallbackDiv = document.createElement('div');
                        fallbackDiv.className = 'w-full h-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400 text-4xl sm:text-5xl font-bold';
                        fallbackDiv.textContent = fallbackInitial;
                        this.replaceWith(fallbackDiv);
                    };
                    imageContainer.appendChild(img);

                    const infoContainer = document.createElement('div');
                    infoContainer.className = 'p-3 sm:p-4';
                    infoContainer.innerHTML = `
                        <h3 class="font-semibold text-base text-gray-800 dark:text-gray-100 truncate">${fields.full_name}</h3>
                        <div class="mt-2 text-xs sm:text-sm flex items-center space-x-1">
                            ${renderStars(fields.Rating)}
                        </div>
                    `;

                    profileCard.appendChild(imageContainer);
                    profileCard.appendChild(infoContainer);
                    profilesGrid.appendChild(profileCard);
                });

            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu từ Airtable:', error);
                loadingSpinner.style.display = 'none';
                errorMessage.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAndRenderProfiles);
    </script>
</body>
</html>
